#!/bin/bash

# File containing all key IDs
KEYS_FILE="kms_keys.txt"

# Output results file
RESULTS_FILE="kms_key_full_details.txt"

# Generate the keys file if it doesn't exist
if [ ! -f "$KEYS_FILE" ]; then
    echo "Generating $KEYS_FILE..."
    aws kms list-keys --query "Keys[].KeyId" --output text > $KEYS_FILE
fi

# Clear previous results
> $RESULTS_FILE

# Iterate over each key and describe it
while read -r KEY_ID; do
    echo "Fetching details for key: $KEY_ID" | tee -a $RESULTS_FILE
    
    # Run describe-key and capture all output (stdout and stderr)
    DESCRIBE_OUTPUT=$(aws kms describe-key --key-id "$KEY_ID" --output text 2>&1)
    
    # Print the entire output to the results file and console
    echo "$DESCRIBE_OUTPUT" | tee -a $RESULTS_FILE
    
    # Add a separator for clarity
    echo "----------------------------------------" | tee -a $RESULTS_FILE
done < $KEYS_FILE

echo "Results saved to $RESULTS_FILE"
